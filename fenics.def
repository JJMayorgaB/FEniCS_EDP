Bootstrap: docker
From: dolfinx/dolfinx:stable
Stage: spython-base

%post

# Dependency versions
GMSH_VERSION=4_12_2

mkdir -p /tmp
cd /tmp

# Install system dependencies
export DEBIAN_FRONTEND=noninteractive && \
apt-get -qq update && \
apt-get -y install \
libglu1 \
libxcursor-dev \
libxft2 \
libxinerama1 \
libfltk1.3-dev \
libfreetype6-dev  \
libgl1-mesa-dev \
libocct-foundation-dev \
libocct-data-exchange-dev \
git \
wget \
curl \
ninja-build \
bc \
htop && \
apt-get clean && \
rm -rf /var/lib/apt/lists/* 

#Install Paraview
apt-get update && \
apt-get install -y paraview

# Install system packages for headless operation
apt-get update && apt-get install -y \
xvfb \
x11-utils \
&& apt-get clean \
&& rm -rf /var/lib/apt/lists/*

# Install Python packages
python3 -m pip install --no-cache-dir \
cython \
pkgconfig \
mpi4py \
pyvista \
matplotlib \
seaborn \
jupyter \
jupyterlab \
ipywidgets \
imageio \
trame \
trame-vuetify \
trame-vtk
    
cd /tmp && curl -sS https://starship.rs/install.sh > install_starship.sh  &&  sh install_starship.sh --yes
echo 'eval "$(starship init bash)"' >> ~/.bashrc

# Set working directory
mkdir -p /workspace
cd /workspace

# Set environment variables for runtime
#ENV HDF5_MPI=ON
#ENV HDF5_PKGCONFIG_NAME=hdf5
XDG_RUNTIME_DIR=/tmp
MESA_GL_VERSION_OVERRIDE=3.3

# Expose common ports for Jupyter
# EXPOSE 8888

# Default command
%environment
export XDG_RUNTIME_DIR=/tmp
export MESA_GL_VERSION_OVERRIDE=3.3
%runscript
cd /workspace
exec /bin/bash /bin/bash "$@"
%startscript
cd /workspace
exec /bin/bash /bin/bash "$@"
